<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Field Hunter">
<link rel="manifest" href="manifest.json">
<title>Field Hunter Pro v2</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
:root{--orange:#f97316;--charcoal:#0a0a0a;--slate:#1a1a1a;--steel:#2a2a2a;--silver:#a3a3a3;--critical:#ef4444;--silicone:#3b82f6;--good:#22c55e;--purple:#8b5cf6;--amber:#f59e0b}
html,body{height:100%}
body{font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display',sans-serif;background:var(--charcoal);color:#fff;min-height:100vh;min-height:-webkit-fill-available;padding-bottom:env(safe-area-inset-bottom,20px);overflow-x:hidden}

/* Header */
.header{position:sticky;top:0;z-index:100;background:rgba(10,10,10,.95);backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);border-bottom:1px solid rgba(255,255,255,.08);padding:env(safe-area-inset-top,0) 16px 0}
.header-content{display:flex;align-items:center;justify-content:space-between;padding:12px 0}
.logo{display:flex;align-items:center;gap:12px}
.logo-icon{width:44px;height:44px;background:linear-gradient(135deg,var(‚Äìorange),#ea580c);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 4px 12px rgba(249,115,22,.3)}
.logo-text h1{font-size:17px;font-weight:700;letter-spacing:-.3px}
.logo-text p{font-size:11px;color:var(‚Äìsilver);font-weight:500}
.comm-badge{background:linear-gradient(135deg,var(‚Äìgood),#16a34a);color:#fff;padding:6px 14px;border-radius:20px;font-size:14px;font-weight:700;box-shadow:0 2px 8px rgba(34,197,94,.3)}

/* Navigation */
.nav{display:flex;gap:6px;padding:10px 0;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;-ms-overflow-style:none}
.nav::-webkit-scrollbar{display:none}
.nav-btn{flex-shrink:0;padding:10px 16px;background:var(‚Äìsteel);border:none;border-radius:20px;color:var(‚Äìsilver);font-size:13px;font-weight:600;transition:all .2s ease;display:flex;align-items:center;gap:6px}
.nav-btn.active{background:var(‚Äìorange);color:#fff;box-shadow:0 2px 12px rgba(249,115,22,.4)}
.nav-btn span{background:rgba(255,255,255,.2);padding:2px 8px;border-radius:10px;font-size:11px}

/* Main Content */
.main{padding:16px;display:none}
.main.active{display:block}

/* Cards */
.card{background:var(‚Äìslate);border-radius:20px;padding:20px;margin-bottom:16px;border:1px solid rgba(255,255,255,.06)}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.card-title{font-size:15px;font-weight:600}

/* Radar */
.radar{position:relative;width:220px;height:220px;margin:0 auto 24px}
.radar-circle{position:absolute;border-radius:50%;border:1px solid rgba(255,255,255,.08)}
.radar-circle:nth-child(1){inset:0}
.radar-circle:nth-child(2){inset:20%}
.radar-circle:nth-child(3){inset:40%}
.radar-sweep{position:absolute;top:50%;left:50%;width:50%;height:2px;transform-origin:left;background:linear-gradient(90deg,rgba(59,130,246,.8),transparent);animation:sweep 2s linear infinite;display:none}
.radar-sweep.active{display:block}
.radar-sweep.dwelling{background:linear-gradient(90deg,rgba(249,115,22,.9),transparent)}
@keyframes sweep{to{transform:rotate(360deg)}}
.radar-center{position:absolute;inset:30%;border-radius:50%;background:var(‚Äìsteel);display:flex;align-items:center;justify-content:center;font-size:32px;transition:all .3s ease;border:2px solid rgba(255,255,255,.1)}
.radar-center.tracking{background:linear-gradient(135deg,var(‚Äìsilicone),#2563eb);border-color:rgba(59,130,246,.5);box-shadow:0 0 30px rgba(59,130,246,.4)}
.radar-center.dwelling{background:linear-gradient(135deg,var(‚Äìorange),#ea580c);border-color:rgba(249,115,22,.5);box-shadow:0 0 30px rgba(249,115,22,.5);animation:pulse 1s ease-in-out infinite}
.radar-center.captured{background:linear-gradient(135deg,var(‚Äìgood),#16a34a);border-color:rgba(34,197,94,.5);box-shadow:0 0 30px rgba(34,197,94,.5)}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.progress-ring{position:absolute;inset:-8px;transform:rotate(-90deg)}
.progress-ring circle{fill:none;stroke-width:4;stroke-linecap:round}
.progress-ring .bg{stroke:rgba(249,115,22,.15)}
.progress-ring .progress{stroke:var(‚Äìorange);transition:stroke-dashoffset .3s ease}

/* Stats Grid */
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-bottom:20px}
.stat{background:rgba(255,255,255,.04);border-radius:14px;padding:14px 10px;text-align:center}
.stat-label{font-size:10px;color:var(‚Äìsilver);margin-bottom:6px;font-weight:500}
.stat-value{font-size:20px;font-weight:700}
.stat-value span{font-size:11px;color:var(‚Äìsilver);font-weight:500}

/* Buttons */
.btn{width:100%;padding:16px;border-radius:14px;border:none;font-size:15px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all .2s ease;-webkit-tap-highlight-color:transparent}
.btn:active{transform:scale(.98)}
.btn-primary{background:linear-gradient(135deg,var(‚Äìorange),#ea580c);color:#fff;box-shadow:0 4px 16px rgba(249,115,22,.3)}
.btn-stop{background:rgba(239,68,68,.15);color:#ef4444;border:1px solid rgba(239,68,68,.3)}
.btn-success{background:linear-gradient(135deg,var(‚Äìgood),#16a34a);color:#fff;box-shadow:0 4px 16px rgba(34,197,94,.3)}
.btn-secondary{background:var(‚Äìsteel);color:#fff;border:1px solid rgba(255,255,255,.1)}

/* Weather Alert */
.weather-alert{display:flex;align-items:center;gap:14px;background:linear-gradient(135deg,rgba(239,68,68,.15),rgba(249,115,22,.1));border:1px solid rgba(239,68,68,.3);border-radius:16px;padding:16px;margin-bottom:16px}
.weather-alert .icon{font-size:28px}
.weather-alert .title{font-weight:600;font-size:14px}
.weather-alert .sub{font-size:12px;color:var(‚Äìsilver);margin-top:2px}

/* Inputs */
.input{width:100%;background:var(‚Äìsteel);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:14px 16px;color:#fff;font-size:15px;outline:none;transition:border-color .2s}
.input:focus{border-color:var(‚Äìorange)}
.input::placeholder{color:var(‚Äìsilver)}
.input-group{margin-bottom:16px}
.input-group label{display:block;font-size:12px;color:var(‚Äìsilver);margin-bottom:8px;font-weight:500}

/* Quick Buttons */
.quick-btns{display:flex;gap:8px;flex-wrap:wrap}
.quick-btn{padding:10px 16px;background:var(‚Äìsteel);border:1px solid rgba(255,255,255,.1);border-radius:10px;color:#fff;font-size:13px;font-weight:500;cursor:pointer;transition:all .2s}
.quick-btn.active{background:var(‚Äìorange);border-color:var(‚Äìorange)}

/* Leads List */
.lead-card{background:var(‚Äìslate);border-radius:16px;padding:16px;margin-bottom:12px;border:1px solid rgba(255,255,255,.06);position:relative;overflow:hidden}
.lead-card::before{content:‚Äô‚Äô;position:absolute;left:0;top:0;bottom:0;width:4px}
.lead-card.hot::before{background:var(‚Äìcritical)}
.lead-card.warm::before{background:var(‚Äìorange)}
.lead-card.cool::before{background:var(‚Äìsilicone)}
.lead-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px}
.lead-addr{font-weight:600;font-size:14px;line-height:1.4;flex:1;padding-right:12px}
.lead-score{background:var(‚Äìorange);color:#fff;padding:4px 10px;border-radius:8px;font-size:12px;font-weight:700}
.lead-meta{display:flex;flex-wrap:wrap;gap:8px;font-size:12px;color:var(‚Äìsilver)}
.lead-meta span{display:flex;align-items:center;gap:4px}
.lead-actions{display:flex;gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,.06)}
.lead-action{flex:1;padding:10px;background:var(‚Äìsteel);border:none;border-radius:10px;color:#fff;font-size:12px;font-weight:500;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px}

/* Empty State */
.empty{text-align:center;padding:60px 20px}
.empty-icon{font-size:48px;margin-bottom:16px;opacity:.5}
.empty h3{font-size:18px;margin-bottom:8px}

/* Commission */
.comm-card{background:linear-gradient(135deg,var(‚Äìgood),#16a34a);border-radius:20px;padding:24px;margin-bottom:16px}
.comm-row{display:flex;justify-content:space-between;padding:10px 0;border-bottom:1px solid rgba(255,255,255,.15);font-size:14px}
.comm-row.total{border:none;font-size:20px;font-weight:700;padding-top:16px}
.goal-bar{height:8px;background:rgba(0,0,0,.2);border-radius:4px;margin-top:16px;overflow:hidden}
.goal-fill{height:100%;background:#fff;border-radius:4px;transition:width .5s ease}
.goal-text{display:flex;justify-content:space-between;margin-top:8px;font-size:12px;opacity:.9}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);z-index:1000;display:flex;align-items:flex-end;opacity:0;visibility:hidden;transition:all .3s ease}
.modal.open{opacity:1;visibility:visible}
.modal-content{background:var(‚Äìcharcoal);width:100%;max-height:90vh;border-radius:24px 24px 0 0;overflow-y:auto;-webkit-overflow-scrolling:touch;transform:translateY(100%);transition:transform .3s ease}
.modal.open .modal-content{transform:translateY(0)}
.modal-header{position:sticky;top:0;background:var(‚Äìcharcoal);padding:20px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,.08);z-index:10}
.modal-header h2{font-size:18px}
.modal-close{width:36px;height:36px;background:var(‚Äìsteel);border:none;border-radius:50%;color:#fff;font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.modal-body{padding:20px}

/* Section Title */
.section-title{font-size:13px;font-weight:600;color:var(‚Äìsilver);margin:20px 0 12px;display:flex;align-items:center;gap:8px}
.section-title:first-child{margin-top:0}

/* Photo Grid */
.photo-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.photo-item{aspect-ratio:1;background:var(‚Äìsteel);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;cursor:pointer;overflow:hidden;border:2px dashed rgba(255,255,255,.1)}
.photo-item img{width:100%;height:100%;object-fit:cover}
.photo-item.has-photo{border:none}

/* Voice Button */
.voice-btn{width:100%;padding:16px;background:var(‚Äìsteel);border:2px solid rgba(255,255,255,.1);border-radius:14px;color:#fff;font-size:14px;font-weight:500;cursor:pointer;transition:all .2s;margin-bottom:12px}
.voice-btn.recording{background:rgba(239,68,68,.2);border-color:var(‚Äìcritical);color:var(‚Äìcritical);animation:voicePulse 1s infinite}
@keyframes voicePulse{0%,100%{opacity:1}50%{opacity:.7}}

/* Notes */
.notes-area{width:100%;min-height:100px;background:var(‚Äìsteel);border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:14px;color:#fff;font-size:14px;font-family:inherit;resize:none;outline:none}
.notes-area:focus{border-color:var(‚Äìorange)}

/* Reminder Buttons */
.reminder-btns{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
.reminder-btn{padding:12px 8px;background:var(‚Äìsteel);border:1px solid rgba(255,255,255,.1);border-radius:10px;color:#fff;font-size:12px;font-weight:500;cursor:pointer;transition:all .2s}
.reminder-btn.active{background:var(‚Äìpurple);border-color:var(‚Äìpurple)}

/* Score Badge */
.score-badge{width:70px;height:70px;border-radius:50%;display:flex;flex-direction:column;align-items:center;justify-content:center}
.score-badge.hot{background:linear-gradient(135deg,var(‚Äìcritical),#dc2626)}
.score-badge.warm{background:linear-gradient(135deg,var(‚Äìorange),#ea580c)}
.score-badge.cool{background:linear-gradient(135deg,var(‚Äìsilicone),#2563eb)}
.score-badge .score{font-size:24px;font-weight:700}
.score-badge .label{font-size:8px;text-transform:uppercase;opacity:.8}

/* ROI Box */
.roi-box{background:var(‚Äìsteel);border-radius:14px;padding:16px;margin-top:16px}
.roi-option{padding:12px;border-radius:10px;margin-bottom:10px}
.roi-option.tpo{background:rgba(249,115,22,.1);border:1px solid rgba(249,115,22,.3)}
.roi-option.silicone{background:rgba(59,130,246,.1);border:1px solid rgba(59,130,246,.3)}
.roi-header{display:flex;justify-content:space-between;align-items:center}
.roi-title{font-weight:600;font-size:13px}
.roi-value{font-weight:700;color:var(‚Äìgood)}
.roi-summary{background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);border-radius:10px;padding:14px;text-align:center;margin-top:12px}
.roi-summary-label{font-size:10px;color:var(‚Äìsilver);text-transform:uppercase}
.roi-summary-value{font-size:28px;font-weight:700;color:var(‚Äìgood)}
.roi-summary-sub{font-size:12px;color:var(‚Äìsilver)}

/* Connection Badge */
.conn-badge{padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600}
.conn-badge.online{background:rgba(34,197,94,.2);color:var(‚Äìgood)}
.conn-badge.offline{background:rgba(239,68,68,.2);color:var(‚Äìcritical)}

/* Proposal */
.proposal-section{margin-bottom:24px}
.proposal-section h3{font-size:14px;color:var(‚Äìsilver);margin-bottom:12px;text-transform:uppercase;letter-spacing:.5px}
.proposal-table{width:100%;border-collapse:collapse}
.proposal-table td{padding:10px 0;border-bottom:1px solid rgba(255,255,255,.08)}
.proposal-table td:last-child{text-align:right;font-weight:600}
.proposal-total{font-size:24px;font-weight:700;color:var(‚Äìgood);text-align:center;padding:20px;background:rgba(34,197,94,.1);border-radius:14px;margin-top:16px}

/* Comp Tag */
.comp-tag{display:inline-flex;align-items:center;gap:6px;background:var(‚Äìsteel);padding:6px 12px;border-radius:8px;font-size:12px;margin:4px 4px 4px 0}
.comp-tag button{background:none;border:none;color:var(‚Äìcritical);cursor:pointer;font-size:14px}
</style>

</head>
<body>
<div id="app">
  <header class="header">
    <div class="header-content">
      <div class="logo">
        <div class="logo-icon">üéØ</div>
        <div class="logo-text">
          <h1>Field Hunter Pro</h1>
          <p>v2 ‚Ä¢ Dalmex Routes</p>
        </div>
      </div>
      <div class="comm-badge" id="commBadge">$0</div>
    </div>
    <nav class="nav">
      <button class="nav-btn active" data-tab="radar">üì° Radar</button>
      <button class="nav-btn" data-tab="leads">üìã Leads <span id="leadCountNav">0</span></button>
      <button class="nav-btn" data-tab="commission">üí∞ Commission</button>
    </nav>
  </header>

  <!-- Radar Tab -->

  <main class="main active" id="radarTab">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
        <span id="statusText" style="font-weight:600">Ready to Hunt</span>
        <span class="conn-badge online" id="connBadge">üì∂ Online</span>
      </div>

```
  <div class="radar">
    <div class="radar-circle"></div>
    <div class="radar-circle"></div>
    <div class="radar-circle"></div>
    <svg class="progress-ring" viewBox="0 0 100 100">
      <circle class="bg" cx="50" cy="50" r="45"/>
      <circle class="progress" cx="50" cy="50" r="45" stroke-dasharray="283" stroke-dashoffset="283" id="progressCircle"/>
    </svg>
    <div class="radar-sweep" id="radarSweep"></div>
    <div class="radar-center" id="radarCenter">üß≠</div>
  </div>

  <div class="stats">
    <div class="stat">
      <div class="stat-label">‚ö° Speed</div>
      <div class="stat-value"><span id="speedValue">--</span> <span>mph</span></div>
    </div>
    <div class="stat">
      <div class="stat-label">‚è±Ô∏è Dwell</div>
      <div class="stat-value" id="dwellTime">0:00</div>
    </div>
    <div class="stat">
      <div class="stat-label">üìç Today</div>
      <div class="stat-value" id="todayLeads">0</div>
    </div>
    <div class="stat">
      <div class="stat-label">üî• Hot</div>
      <div class="stat-value" id="hotLeads">0</div>
    </div>
  </div>

  <button class="btn btn-primary" id="controlBtn">üß≠ Start Route</button>
</div>

<div class="weather-alert" id="weatherAlert" style="display:none">
  <div class="icon">‚õàÔ∏è</div>
  <div>
    <div class="title">Storm Activity Nearby</div>
    <div class="sub" id="weatherText">Hail reported in your area</div>
  </div>
</div>

<div class="card" id="locCard" style="display:none">
  <div style="font-size:13px;color:var(--silver);margin-bottom:8px">üìç Current Location</div>
  <div id="locText" style="font-weight:600">--</div>
  <div id="accText" style="font-size:12px;color:var(--silver);margin-top:4px">--</div>
</div>
```

  </main>

  <!-- Leads Tab -->

  <main class="main" id="leadsTab">
    <input type="text" class="input" placeholder="üîç Search leads..." id="searchInput" style="margin-bottom:16px">
    <div id="leadsContainer">
      <div class="empty" id="leadsEmpty">
        <div class="empty-icon">üìç</div>
        <h3>No Leads Yet</h3>
        <p style="color:var(--silver)">Start your route to capture leads automatically.</p>
      </div>
    </div>
  </main>

  <!-- Commission Tab -->

  <main class="main" id="commissionTab">
    <div class="comm-card">
      <h3 style="font-size:14px;opacity:.9;margin-bottom:16px">üí∞ This Month</h3>
      <div class="comm-row"><span>Proposals Sent</span><span id="propCount">0</span></div>
      <div class="comm-row"><span>Deals Closed</span><span id="dealCount">0</span></div>
      <div class="comm-row"><span>Contract Value</span><span id="contractVal">$0</span></div>
      <div class="comm-row total"><span>Commission</span><span id="totalComm">$0</span></div>
      <div class="goal-bar"><div class="goal-fill" id="goalFill"></div></div>
      <div class="goal-text"><span>Monthly Goal</span><span id="goalText">$0 / $10,000</span></div>
    </div>

```
<div class="card">
  <div style="font-weight:600;margin-bottom:16px">‚ûï Log a Deal</div>
  <div class="input-group">
    <label>Contract Value ($)</label>
    <input type="number" class="input" id="dealInput" placeholder="e.g. 80000">
  </div>
  <div class="input-group">
    <label>Commission Rate</label>
    <div class="quick-btns">
      <button class="quick-btn active" data-rate="5">5%</button>
      <button class="quick-btn" data-rate="7">7%</button>
      <button class="quick-btn" data-rate="10">10%</button>
      <button class="quick-btn" data-rate="15">15%</button>
    </div>
  </div>
  <button class="btn btn-success" id="logDealBtn">üí∞ Log Deal</button>
</div>

<div class="card">
  <div style="font-weight:600;margin-bottom:16px">üéØ Monthly Goal</div>
  <div class="input-group">
    <label>Goal Amount ($)</label>
    <input type="number" class="input" id="goalInput" placeholder="10000">
  </div>
  <button class="btn btn-secondary" id="setGoalBtn">Set Goal</button>
</div>
```

  </main>
</div>

<!-- Capture Modal -->

<div class="modal" id="captureModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üéØ Lead Captured!</h2>
      <button class="modal-close" id="dismissCapture">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="weather-alert" id="modalWeather" style="display:none">
        <div class="icon">‚õàÔ∏è</div>
        <div>
          <div class="title">Recent Storm Activity</div>
          <div class="sub">Potential hail damage in this area</div>
        </div>
      </div>

```
  <div class="section-title">üìç Location</div>
  <div style="background:var(--steel);border-radius:12px;padding:14px;margin-bottom:4px">
    <div id="captureAddr" style="font-weight:600">Looking up address...</div>
    <div id="captureDwell" style="font-size:12px;color:var(--silver);margin-top:6px">--</div>
  </div>

  <div class="section-title">üè¢ Property Info</div>
  <div class="input-group">
    <label>Year Built</label>
    <input type="number" class="input" id="yearInput" placeholder="e.g. 2005">
  </div>
  <div class="input-group">
    <label>Roof Square Footage</label>
    <div class="quick-btns" style="margin-bottom:8px">
      <button class="quick-btn" data-sqft="5000">5K</button>
      <button class="quick-btn" data-sqft="10000">10K</button>
      <button class="quick-btn" data-sqft="20000">20K</button>
      <button class="quick-btn" data-sqft="50000">50K</button>
    </div>
    <input type="number" class="input" id="sqftInput" placeholder="Or enter exact sqft">
  </div>
  <div class="input-group">
    <label>Owner or Tenant?</label>
    <div class="quick-btns" id="ownerBtns">
      <button class="quick-btn" data-owner="owner">Owner</button>
      <button class="quick-btn" data-owner="tenant">Tenant</button>
      <button class="quick-btn active" data-owner="unknown">Unknown</button>
    </div>
  </div>

  <div class="section-title">üì∑ Photos</div>
  <div class="photo-grid" id="photoGrid">
    <div class="photo-item" id="addPhotoBtn">üì∑</div>
    <div class="photo-item" style="opacity:.5">‚ûï</div>
    <div class="photo-item" style="opacity:.3">‚ûï</div>
    <div class="photo-item" style="opacity:.2">‚ûï</div>
  </div>
  <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none" multiple>

  <div class="section-title">üé§ Voice Note</div>
  <button class="voice-btn" id="voiceBtn">üé§ Tap to Record</button>
  <textarea class="notes-area" id="notesInput" placeholder="Or type notes here..."></textarea>

  <div class="section-title">üöö Competitor Spotted?</div>
  <div style="display:flex;gap:8px">
    <input type="text" class="input" id="compInput" placeholder="e.g. ABC Roofing" style="flex:1">
    <button class="btn btn-secondary" id="addCompBtn" style="width:auto;padding:14px 20px">Add</button>
  </div>
  <div id="compList" style="margin-top:10px"></div>

  <div class="section-title">‚è∞ Follow-up Reminder</div>
  <div class="reminder-btns" id="reminderBtns">
    <button class="reminder-btn" data-days="1">Tomorrow</button>
    <button class="reminder-btn" data-days="3">3 Days</button>
    <button class="reminder-btn" data-days="7">1 Week</button>
    <button class="reminder-btn" data-days="14">2 Weeks</button>
  </div>

  <div class="section-title">üìä Score & ROI Preview</div>
  <div id="previewBox" style="background:var(--steel);border-radius:14px;padding:16px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div>
        <div style="font-size:12px;color:var(--silver)">Scout Score</div>
        <div style="font-size:36px;font-weight:700" id="previewScore">--</div>
      </div>
      <div class="score-badge cool" id="previewBadge">
        <span class="score" id="badgeNum">--</span>
        <span class="label">SCORE</span>
      </div>
    </div>
    <div class="roi-box" id="roiBox" style="display:none;margin-top:16px;background:var(--charcoal)">
      <div class="roi-option tpo">
        <div class="roi-header">
          <span class="roi-title">TPO Replacement</span>
          <span class="roi-value" id="tpoNet">$0</span>
        </div>
        <div style="font-size:11px;color:var(--silver);margin-top:4px">Gross: <span id="tpoGross">$0</span> ‚Ä¢ 39yr depreciation</div>
      </div>
      <div class="roi-option silicone">
        <div class="roi-header">
          <span class="roi-title">Silicone Coating</span>
          <span class="roi-value" id="silNet">$0</span>
        </div>
        <div style="font-size:11px;color:var(--silver);margin-top:4px">Gross: <span id="silGross">$0</span> ‚Ä¢ 100% Year 1</div>
      </div>
      <div class="roi-summary">
        <div class="roi-summary-label">Year 1 Savings</div>
        <div class="roi-summary-value" id="savingsVal">$0</div>
        <div class="roi-summary-sub" id="savingsPct">vs TPO replacement</div>
      </div>
    </div>
  </div>

  <div style="margin-top:24px;display:flex;flex-direction:column;gap:12px">
    <button class="btn btn-success" id="saveLeadBtn">‚úì Save Lead</button>
    <button class="btn btn-primary" id="saveProposalBtn">üìÑ Save & Generate Proposal</button>
    <button class="btn btn-secondary" id="discardBtn">Discard</button>
  </div>
</div>
```

  </div>
</div>

<!-- Proposal Modal -->

<div class="modal" id="proposalModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üìÑ Proposal</h2>
      <button class="modal-close" id="closeProposal">‚úï</button>
    </div>
    <div class="modal-body" id="proposalBody"></div>
  </div>
</div>

<!-- Lead Detail Modal -->

<div class="modal" id="leadModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>üìç Lead Details</h2>
      <button class="modal-close" id="closeLeadModal">‚úï</button>
    </div>
    <div class="modal-body" id="leadModalBody"></div>
  </div>
</div>

<script>
// ======================
// STATE MANAGEMENT
// ======================
const STATE = {
  status: 'IDLE', // IDLE, TRACKING, DWELLING, CAPTURED
  tracking: false,
  position: null,
  speed: null,
  dwellStart: null,
  dwellDuration: 0,
  leads: [],
  capture: null,
  watchId: null,
  posBuffer: [],
  photos: [],
  competitors: [],
  reminder: null,
  owner: 'unknown',
  recording: false,
  deals: [],
  rate: 5,
  goal: 10000
};

const CONFIG = {
  SPEED_THRESHOLD: 2, // mph - below this is "stopped"
  DWELL_THRESHOLD: 120000, // 2 minutes in ms
  METERS_PER_MILE: 1609.34
};

// ======================
// INITIALIZATION
// ======================
document.addEventListener('DOMContentLoaded', () => {
  loadData();
  setupEventListeners();
  updateUI();
  updateConnectionStatus(navigator.onLine);
  
  window.addEventListener('online', () => updateConnectionStatus(true));
  window.addEventListener('offline', () => updateConnectionStatus(false));
});

function loadData() {
  try {
    const saved = localStorage.getItem('fieldHunterProV2');
    if (saved) {
      const data = JSON.parse(saved);
      STATE.leads = data.leads || [];
      STATE.deals = data.deals || [];
      STATE.goal = data.goal || 10000;
    }
  } catch (e) {
    console.error('Error loading data:', e);
  }
  updateLeadCount();
  renderLeads();
  updateCommission();
}

function saveData() {
  try {
    localStorage.setItem('fieldHunterProV2', JSON.stringify({
      leads: STATE.leads,
      deals: STATE.deals,
      goal: STATE.goal
    }));
  } catch (e) {
    console.error('Error saving data:', e);
  }
}

// ======================
// EVENT LISTENERS
// ======================
function setupEventListeners() {
  // Navigation
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const tab = e.currentTarget.dataset.tab;
      showTab(tab);
    });
  });

  // Control button
  document.getElementById('controlBtn').addEventListener('click', toggleTracking);

  // Search
  document.getElementById('searchInput').addEventListener('input', filterLeads);

  // Commission rate buttons
  document.querySelectorAll('[data-rate]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('[data-rate]').forEach(b => b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      STATE.rate = parseInt(e.currentTarget.dataset.rate);
    });
  });

  // Log deal
  document.getElementById('logDealBtn').addEventListener('click', logDeal);

  // Set goal
  document.getElementById('setGoalBtn').addEventListener('click', setGoal);

  // Capture modal
  document.getElementById('dismissCapture').addEventListener('click', dismissCapture);
  document.getElementById('discardBtn').addEventListener('click', dismissCapture);
  document.getElementById('saveLeadBtn').addEventListener('click', saveLead);
  document.getElementById('saveProposalBtn').addEventListener('click', saveAndProposal);

  // Sqft buttons
  document.querySelectorAll('[data-sqft]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('[data-sqft]').forEach(b => b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      document.getElementById('sqftInput').value = e.currentTarget.dataset.sqft;
      updatePreview();
    });
  });

  // Owner buttons
  document.querySelectorAll('[data-owner]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('[data-owner]').forEach(b => b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      STATE.owner = e.currentTarget.dataset.owner;
    });
  });

  // Reminder buttons
  document.querySelectorAll('[data-days]').forEach(btn => {
    btn.addEventListener('click', (e) => {
      document.querySelectorAll('[data-days]').forEach(b => b.classList.remove('active'));
      e.currentTarget.classList.add('active');
      STATE.reminder = parseInt(e.currentTarget.dataset.days);
    });
  });

  // Photo
  document.getElementById('addPhotoBtn').addEventListener('click', () => {
    document.getElementById('photoInput').click();
  });
  document.getElementById('photoInput').addEventListener('change', handlePhotos);

  // Voice
  document.getElementById('voiceBtn').addEventListener('click', toggleVoiceRecording);

  // Competitor
  document.getElementById('addCompBtn').addEventListener('click', addCompetitor);
  document.getElementById('compInput').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') addCompetitor();
  });

  // Preview updates
  document.getElementById('yearInput').addEventListener('input', updatePreview);
  document.getElementById('sqftInput').addEventListener('input', updatePreview);

  // Close modals
  document.getElementById('closeProposal').addEventListener('click', () => {
    document.getElementById('proposalModal').classList.remove('open');
  });
  document.getElementById('closeLeadModal').addEventListener('click', () => {
    document.getElementById('leadModal').classList.remove('open');
  });
}

// ======================
// NAVIGATION
// ======================
function showTab(tabName) {
  document.querySelectorAll('.main').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById(tabName + 'Tab').classList.add('active');
  document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
}

// ======================
// TRACKING
// ======================
function toggleTracking() {
  if (STATE.tracking) {
    stopTracking();
  } else {
    startTracking();
  }
}

function startTracking() {
  if (!navigator.geolocation) {
    alert('GPS not supported on this device');
    return;
  }

  STATE.tracking = true;
  STATE.status = 'TRACKING';
  STATE.posBuffer = [];

  STATE.watchId = navigator.geolocation.watchPosition(
    handlePosition,
    handlePositionError,
    {
      enableHighAccuracy: true,
      timeout: 15000,
      maximumAge: 0
    }
  );

  updateUI();
}

function stopTracking() {
  if (STATE.watchId) {
    navigator.geolocation.clearWatch(STATE.watchId);
    STATE.watchId = null;
  }

  STATE.tracking = false;
  STATE.status = 'IDLE';
  STATE.speed = null;
  STATE.dwellStart = null;
  STATE.dwellDuration = 0;

  updateUI();
}

function handlePosition(pos) {
  const newPos = {
    lat: pos.coords.latitude,
    lon: pos.coords.longitude,
    accuracy: pos.coords.accuracy,
    timestamp: pos.timestamp
  };

  STATE.position = newPos;
  STATE.posBuffer.push(newPos);
  if (STATE.posBuffer.length > 10) STATE.posBuffer.shift();

  // Calculate speed
  if (STATE.posBuffer.length >= 2) {
    const prev = STATE.posBuffer[STATE.posBuffer.length - 2];
    STATE.speed = calculateSpeed(prev, newPos);
  }

  // Check if stopped (dwell detection)
  const isStopped = STATE.speed !== null && STATE.speed < CONFIG.SPEED_THRESHOLD;

  if (isStopped) {
    if (STATE.status === 'TRACKING') {
      STATE.status = 'DWELLING';
      STATE.dwellStart = Date.now();
      STATE.dwellDuration = 0;
    } else if (STATE.status === 'DWELLING') {
      STATE.dwellDuration = Date.now() - STATE.dwellStart;
      
      // Auto-capture after threshold
      if (STATE.dwellDuration >= CONFIG.DWELL_THRESHOLD && !STATE.capture) {
        triggerCapture();
      }
    }
  } else {
    // Moving - reset dwell
    if (STATE.status === 'DWELLING') {
      STATE.status = 'TRACKING';
      STATE.dwellStart = null;
      STATE.dwellDuration = 0;
    }
  }

  updateUI();
  updateLocationCard();
}

function handlePositionError(err) {
  console.error('Position error:', err);
  if (err.code === 1) {
    alert('Location access denied. Please enable location services.');
    stopTracking();
  } else if (err.code === 2) {
    alert('Position unavailable. Please try again.');
  }
}

function calculateSpeed(posA, posB) {
  const R = 6371e3; // Earth radius in meters
  const lat1 = posA.lat * Math.PI / 180;
  const lat2 = posB.lat * Math.PI / 180;
  const dLat = (posB.lat - posA.lat) * Math.PI / 180;
  const dLon = (posB.lon - posA.lon) * Math.PI / 180;

  const a = Math.sin(dLat/2) ** 2 + Math.cos(lat1) * Math.cos(lat2) * Math.sin(dLon/2) ** 2;
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const distance = R * c; // meters

  const timeSeconds = (posB.timestamp - posA.timestamp) / 1000;
  if (timeSeconds <= 0) return 0;

  const speedMps = distance / timeSeconds;
  const speedMph = (speedMps * 3600) / CONFIG.METERS_PER_MILE;

  return Math.max(0, speedMph);
}

// ======================
// CAPTURE
// ======================
function triggerCapture() {
  STATE.status = 'CAPTURED';
  STATE.capture = {
    id: 'lead_' + Date.now(),
    coords: { ...STATE.position },
    dwellDuration: STATE.dwellDuration,
    timestamp: new Date().toISOString()
  };

  // Reset capture form state
  STATE.photos = [];
  STATE.competitors = [];
  STATE.reminder = null;
  STATE.owner = 'unknown';

  // Vibrate if supported
  if ('vibrate' in navigator) {
    navigator.vibrate([200, 100, 200]);
  }

  // Reverse geocode
  reverseGeocode(STATE.position);

  // Reset form
  document.getElementById('yearInput').value = '';
  document.getElementById('sqftInput').value = '';
  document.getElementById('notesInput').value = '';
  document.getElementById('compInput').value = '';
  document.getElementById('compList').innerHTML = '';
  document.getElementById('captureDwell').textContent = formatDuration(STATE.dwellDuration) + ' at this location';
  
  // Reset button states
  document.querySelectorAll('[data-sqft]').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('[data-owner]').forEach(b => b.classList.remove('active'));
  document.querySelector('[data-owner="unknown"]').classList.add('active');
  document.querySelectorAll('[data-days]').forEach(b => b.classList.remove('active'));
  
  // Reset photo grid
  renderPhotoGrid();
  
  // Update preview
  updatePreview();

  // Open modal
  document.getElementById('captureModal').classList.add('open');
  updateUI();
}

async function reverseGeocode(pos) {
  const addrEl = document.getElementById('captureAddr');
  addrEl.textContent = 'Looking up address...';

  try {
    const response = await fetch(
      `https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.lat}&lon=${pos.lon}`
    );
    const data = await response.json();
    
    if (data.display_name) {
      const parts = data.display_name.split(',');
      const shortAddr = parts.slice(0, 3).join(',').trim();
      addrEl.textContent = shortAddr;
      if (STATE.capture) {
        STATE.capture.address = data.display_name;
        STATE.capture.shortAddress = shortAddr;
      }
    } else {
      addrEl.textContent = `${pos.lat.toFixed(6)}, ${pos.lon.toFixed(6)}`;
    }
  } catch (e) {
    console.error('Geocode error:', e);
    addrEl.textContent = `${pos.lat.toFixed(6)}, ${pos.lon.toFixed(6)}`;
  }
}

function dismissCapture() {
  document.getElementById('captureModal').classList.remove('open');
  STATE.capture = null;
  STATE.status = STATE.tracking ? 'TRACKING' : 'IDLE';
  STATE.dwellStart = null;
  STATE.dwellDuration = 0;
  updateUI();
}

function saveLead() {
  if (!STATE.capture) return;

  const lead = {
    ...STATE.capture,
    yearBuilt: document.getElementById('yearInput').value || null,
    sqft: document.getElementById('sqftInput').value || null,
    owner: STATE.owner,
    photos: [...STATE.photos],
    competitors: [...STATE.competitors],
    notes: document.getElementById('notesInput').value || '',
    reminder: STATE.reminder,
    score: calculateScore(),
    savedAt: new Date().toISOString()
  };

  STATE.leads.unshift(lead);
  saveData();
  updateLeadCount();
  renderLeads();

  dismissCapture();
  
  // Show confirmation
  alert('Lead saved successfully!');
}

function saveAndProposal() {
  if (!STATE.capture) return;

  const lead = {
    ...STATE.capture,
    yearBuilt: document.getElementById('yearInput').value || null,
    sqft: document.getElementById('sqftInput').value || null,
    owner: STATE.owner,
    photos: [...STATE.photos],
    competitors: [...STATE.competitors],
    notes: document.getElementById('notesInput').value || '',
    reminder: STATE.reminder,
    score: calculateScore(),
    savedAt: new Date().toISOString()
  };

  STATE.leads.unshift(lead);
  saveData();
  updateLeadCount();
  renderLeads();

  // Generate proposal
  generateProposal(lead);

  dismissCapture();
}

function calculateScore() {
  let score = 50; // Base score

  const year = parseInt(document.getElementById('yearInput').value);
  const sqft = parseInt(document.getElementById('sqftInput').value);

  // Age bonus (older = higher priority)
  if (year) {
    const age = new Date().getFullYear() - year;
    if (age > 20) score += 25;
    else if (age > 15) score += 20;
    else if (age > 10) score += 15;
    else if (age > 5) score += 5;
  }

  // Size bonus
  if (sqft) {
    if (sqft >= 50000) score += 20;
    else if (sqft >= 20000) score += 15;
    else if (sqft >= 10000) score += 10;
    else if (sqft >= 5000) score += 5;
  }

  // Owner bonus
  if (STATE.owner === 'owner') score += 10;

  // Dwell time bonus (longer = more interest)
  if (STATE.capture && STATE.capture.dwellDuration > 180000) score += 5;

  return Math.min(100, score);
}

function updatePreview() {
  const score = calculateScore();
  document.getElementById('previewScore').textContent = score;
  document.getElementById('badgeNum').textContent = score;

  const badge = document.getElementById('previewBadge');
  badge.classList.remove('hot', 'warm', 'cool');
  
  if (score >= 80) {
    badge.classList.add('hot');
  } else if (score >= 60) {
    badge.classList.add('warm');
  } else {
    badge.classList.add('cool');
  }

  // ROI calculations
  const sqft = parseInt(document.getElementById('sqftInput').value);
  const roiBox = document.getElementById('roiBox');
  
  if (sqft && sqft > 0) {
    roiBox.style.display = 'block';
    
    // TPO: ~$8-12/sqft, 39-year depreciation
    const tpoGross = sqft * 10;
    const tpoNet = Math.round(tpoGross / 39);
    
    // Silicone: ~$3-5/sqft, 100% year 1 deduction
    const silGross = sqft * 4;
    const silNet = silGross;
    
    const savings = silNet - tpoNet;
    const savingsPct = Math.round((savings / tpoNet) * 100);

    document.getElementById('tpoGross').textContent = '$' + tpoGross.toLocaleString();
    document.getElementById('tpoNet').textContent = '$' + tpoNet.toLocaleString() + '/yr';
    document.getElementById('silGross').textContent = '$' + silGross.toLocaleString();
    document.getElementById('silNet').textContent = '$' + silNet.toLocaleString();
    document.getElementById('savingsVal').textContent = '$' + savings.toLocaleString();
    document.getElementById('savingsPct').textContent = savingsPct + '% tax advantage Year 1';
  } else {
    roiBox.style.display = 'none';
  }
}

// ======================
// PHOTOS
// ======================
function handlePhotos(e) {
  const files = e.target.files;
  for (let file of files) {
    if (STATE.photos.length >= 4) break;
    
    const reader = new FileReader();
    reader.onload = (event) => {
      STATE.photos.push(event.target.result);
      renderPhotoGrid();
    };
    reader.readAsDataURL(file);
  }
  e.target.value = '';
}

function renderPhotoGrid() {
  const grid = document.getElementById('photoGrid');
  grid.innerHTML = '';

  STATE.photos.forEach((photo, i) => {
    const div = document.createElement('div');
    div.className = 'photo-item has-photo';
    div.innerHTML = `<img src="${photo}" alt="Photo ${i+1}">`;
    div.onclick = () => {
      if (confirm('Remove this photo?')) {
        STATE.photos.splice(i, 1);
        renderPhotoGrid();
      }
    };
    grid.appendChild(div);
  });

  // Add placeholder slots
  for (let i = STATE.photos.length; i < 4; i++) {
    const div = document.createElement('div');
    div.className = 'photo-item';
    div.style.opacity = i === STATE.photos.length ? '1' : (0.5 - i * 0.1);
    div.textContent = i === STATE.photos.length ? 'üì∑' : '‚ûï';
    if (i === STATE.photos.length) {
      div.onclick = () => document.getElementById('photoInput').click();
    }
    grid.appendChild(div);
  }
}

// ======================
// VOICE RECORDING
// ======================
function toggleVoiceRecording() {
  const btn = document.getElementById('voiceBtn');
  
  if (!STATE.recording) {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      alert('Voice recognition not supported in this browser. Please type your notes instead.');
      return;
    }

    STATE.recording = true;
    btn.classList.add('recording');
    btn.textContent = 'üî¥ Recording... Tap to Stop';

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    STATE.recognition = new SpeechRecognition();
    STATE.recognition.continuous = true;
    STATE.recognition.interimResults = true;

    STATE.recognition.onresult = (event) => {
      let transcript = '';
      for (let i = 0; i < event.results.length; i++) {
        transcript += event.results[i][0].transcript;
      }
      document.getElementById('notesInput').value = transcript;
    };

    STATE.recognition.onerror = (event) => {
      console.error('Speech recognition error:', event.error);
      stopVoiceRecording();
    };

    STATE.recognition.onend = () => {
      stopVoiceRecording();
    };

    STATE.recognition.start();
  } else {
    stopVoiceRecording();
  }
}

function stopVoiceRecording() {
  STATE.recording = false;
  const btn = document.getElementById('voiceBtn');
  btn.classList.remove('recording');
  btn.textContent = 'üé§ Tap to Record';
  
  if (STATE.recognition) {
    STATE.recognition.stop();
    STATE.recognition = null;
  }
}

// ======================
// COMPETITORS
// ======================
function addCompetitor() {
  const input = document.getElementById('compInput');
  const name = input.value.trim();
  
  if (name && !STATE.competitors.includes(name)) {
    STATE.competitors.push(name);
    renderCompetitors();
    input.value = '';
  }
}

function renderCompetitors() {
  const container = document.getElementById('compList');
  container.innerHTML = STATE.competitors.map((comp, i) => `
    <span class="comp-tag">
      üöö ${comp}
      <button onclick="removeCompetitor(${i})">√ó</button>
    </span>
  `).join('');
}

function removeCompetitor(index) {
  STATE.competitors.splice(index, 1);
  renderCompetitors();
}

// ======================
// LEADS
// ======================
function updateLeadCount() {
  const today = new Date().toDateString();
  const todayLeads = STATE.leads.filter(l => new Date(l.savedAt).toDateString() === today);
  const hotLeads = STATE.leads.filter(l => l.score >= 80);

  document.getElementById('leadCountNav').textContent = STATE.leads.length;
  document.getElementById('todayLeads').textContent = todayLeads.length;
  document.getElementById('hotLeads').textContent = hotLeads.length;
}

function renderLeads() {
  const container = document.getElementById('leadsContainer');
  const empty = document.getElementById('leadsEmpty');

  if (STATE.leads.length === 0) {
    empty.style.display = 'block';
    container.innerHTML = '';
    container.appendChild(empty);
    return;
  }

  empty.style.display = 'none';
  container.innerHTML = STATE.leads.map((lead, i) => {
    const scoreClass = lead.score >= 80 ? 'hot' : (lead.score >= 60 ? 'warm' : 'cool');
    const date = new Date(lead.savedAt);
    const dateStr = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    
    return `
      <div class="lead-card ${scoreClass}" onclick="viewLead(${i})">
        <div class="lead-header">
          <div class="lead-addr">${lead.shortAddress || lead.address || 'Unknown Location'}</div>
          <div class="lead-score">${lead.score}</div>
        </div>
        <div class="lead-meta">
          <span>üìÖ ${dateStr}</span>
          ${lead.sqft ? `<span>üìê ${parseInt(lead.sqft).toLocaleString()} sqft</span>` : ''}
          ${lead.yearBuilt ? `<span>üèóÔ∏è ${lead.yearBuilt}</span>` : ''}
          ${lead.photos && lead.photos.length ? `<span>üì∑ ${lead.photos.length}</span>` : ''}
        </div>
        <div class="lead-actions">
          <button class="lead-action" onclick="event.stopPropagation();callLead(${i})">üìû Call</button>
          <button class="lead-action" onclick="event.stopPropagation();navigateTo(${i})">üó∫Ô∏è Navigate</button>
          <button class="lead-action" onclick="event.stopPropagation();generateProposal(STATE.leads[${i}])">üìÑ Proposal</button>
        </div>
      </div>
    `;
  }).join('');
}

function filterLeads() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  const cards = document.querySelectorAll('.lead-card');
  
  cards.forEach(card => {
    const text = card.textContent.toLowerCase();
    card.style.display = text.includes(query) ? 'block' : 'none';
  });
}

function viewLead(index) {
  const lead = STATE.leads[index];
  const modal = document.getElementById('leadModal');
  const body = document.getElementById('leadModalBody');

  body.innerHTML = `
    <div style="background:var(--steel);border-radius:14px;padding:16px;margin-bottom:16px">
      <div style="font-weight:600;font-size:16px;margin-bottom:8px">${lead.shortAddress || lead.address || 'Unknown'}</div>
      <div style="font-size:13px;color:var(--silver)">Captured ${new Date(lead.savedAt).toLocaleString()}</div>
    </div>
    
    <div class="section-title">üìä Scout Score</div>
    <div style="display:flex;align-items:center;gap:16px;margin-bottom:16px">
      <div class="score-badge ${lead.score >= 80 ? 'hot' : (lead.score >= 60 ? 'warm' : 'cool')}">
        <span class="score">${lead.score}</span>
        <span class="label">SCORE</span>
      </div>
      <div>
        <div style="font-size:24px;font-weight:700">${lead.score >= 80 ? 'üî• Hot Lead' : (lead.score >= 60 ? '‚ö° Warm Lead' : '‚ùÑÔ∏è Cool Lead')}</div>
        <div style="font-size:13px;color:var(--silver)">Priority: ${lead.score >= 80 ? 'High' : (lead.score >= 60 ? 'Medium' : 'Low')}</div>
      </div>
    </div>

    ${lead.sqft || lead.yearBuilt ? `
      <div class="section-title">üè¢ Property Details</div>
      <div style="background:var(--steel);border-radius:12px;padding:14px;margin-bottom:16px">
        ${lead.sqft ? `<div style="margin-bottom:8px"><span style="color:var(--silver)">Size:</span> ${parseInt(lead.sqft).toLocaleString()} sqft</div>` : ''}
        ${lead.yearBuilt ? `<div style="margin-bottom:8px"><span style="color:var(--silver)">Year Built:</span> ${lead.yearBuilt}</div>` : ''}
        <div><span style="color:var(--silver)">Owner Status:</span> ${lead.owner || 'Unknown'}</div>
      </div>
    ` : ''}

    ${lead.notes ? `
      <div class="section-title">üìù Notes</div>
      <div style="background:var(--steel);border-radius:12px;padding:14px;margin-bottom:16px">${lead.notes}</div>
    ` : ''}

    ${lead.competitors && lead.competitors.length ? `
      <div class="section-title">üöö Competitors Spotted</div>
      <div style="margin-bottom:16px">${lead.competitors.map(c => `<span class="comp-tag">üöö ${c}</span>`).join('')}</div>
    ` : ''}

    ${lead.photos && lead.photos.length ? `
      <div class="section-title">üì∑ Photos</div>
      <div class="photo-grid" style="margin-bottom:16px">
        ${lead.photos.map(p => `<div class="photo-item has-photo"><img src="${p}"></div>`).join('')}
      </div>
    ` : ''}

    <div style="display:flex;flex-direction:column;gap:10px;margin-top:24px">
      <button class="btn btn-primary" onclick="generateProposal(STATE.leads[${index}]);document.getElementById('leadModal').classList.remove('open')">üìÑ Generate Proposal</button>
      <button class="btn btn-success" onclick="navigateTo(${index})">üó∫Ô∏è Navigate Here</button>
      <button class="btn btn-secondary" onclick="deleteLead(${index})">üóëÔ∏è Delete Lead</button>
    </div>
  `;

  modal.classList.add('open');
}

function deleteLead(index) {
  if (confirm('Delete this lead? This cannot be undone.')) {
    STATE.leads.splice(index, 1);
    saveData();
    updateLeadCount();
    renderLeads();
    document.getElementById('leadModal').classList.remove('open');
  }
}

function callLead(index) {
  alert('Phone integration coming soon! For now, use the address to look up the property owner.');
}

function navigateTo(index) {
  const lead = STATE.leads[index];
  if (lead.coords) {
    window.open(`https://www.google.com/maps/dir/?api=1&destination=${lead.coords.lat},${lead.coords.lon}`, '_blank');
  }
}

// ======================
// PROPOSALS
// ======================
function generateProposal(lead) {
  const sqft = parseInt(lead.sqft) || 10000;
  const tpoGross = sqft * 10;
  const silGross = sqft * 4;
  const savings = silGross - Math.round(tpoGross / 39);

  const body = document.getElementById('proposalBody');
  body.innerHTML = `
    <div class="proposal-section">
      <h3>Property</h3>
      <div style="background:var(--steel);border-radius:12px;padding:16px">
        <div style="font-weight:600;margin-bottom:8px">${lead.shortAddress || lead.address || 'Commercial Property'}</div>
        <div style="font-size:13px;color:var(--silver)">${sqft.toLocaleString()} sqft ‚Ä¢ ${lead.yearBuilt ? 'Built ' + lead.yearBuilt : 'Age Unknown'}</div>
      </div>
    </div>

    <div class="proposal-section">
      <h3>Silicone Coating Solution</h3>
      <table class="proposal-table">
        <tr><td>Roof Area</td><td>${sqft.toLocaleString()} sqft</td></tr>
        <tr><td>Material (Premium Silicone)</td><td>$${(sqft * 2.5).toLocaleString()}</td></tr>
        <tr><td>Labor & Application</td><td>$${(sqft * 1.5).toLocaleString()}</td></tr>
        <tr><td>Warranty (15-Year)</td><td>Included</td></tr>
      </table>
      <div class="proposal-total">
        Total Investment: $${silGross.toLocaleString()}
      </div>
    </div>

    <div class="proposal-section">
      <h3>Tax Advantage</h3>
      <div style="background:rgba(34,197,94,.1);border:1px solid rgba(34,197,94,.3);border-radius:12px;padding:16px">
        <div style="font-size:14px;margin-bottom:8px">‚úÖ <strong>100% Tax Deductible</strong> in Year 1</div>
        <div style="font-size:13px;color:var(--silver)">Unlike TPO replacement (39-year depreciation), silicone coating qualifies as a repair/maintenance expense under IRS guidelines.</div>
        <div style="font-size:20px;font-weight:700;color:var(--good);margin-top:12px">Year 1 Savings: $${savings.toLocaleString()}</div>
      </div>
    </div>

    <div class="proposal-section">
      <h3>Why Silicone Coating?</h3>
      <div style="background:var(--steel);border-radius:12px;padding:16px;font-size:14px;line-height:1.6">
        ‚Ä¢ <strong>Seamless Protection</strong> - No seams to fail or leak<br>
        ‚Ä¢ <strong>Reflective</strong> - Reduces cooling costs 15-25%<br>
        ‚Ä¢ <strong>Extends Roof Life</strong> - Add 15+ years to existing roof<br>
        ‚Ä¢ <strong>Sustainable</strong> - Keeps existing materials out of landfill<br>
        ‚Ä¢ <strong>Fast Installation</strong> - Minimal business disruption
      </div>
    </div>

    <div style="margin-top:24px;display:flex;flex-direction:column;gap:10px">
      <button class="btn btn-success" onclick="shareProposal()">üì§ Share Proposal</button>
      <button class="btn btn-secondary" onclick="document.getElementById('proposalModal').classList.remove('open')">Close</button>
    </div>
  `;

  document.getElementById('proposalModal').classList.add('open');
}

function shareProposal() {
  if (navigator.share) {
    navigator.share({
      title: 'Commercial Roofing Proposal',
      text: 'Your custom silicone coating proposal from Precision Roofing',
      url: window.location.href
    });
  } else {
    alert('Share functionality requires a secure context (HTTPS)');
  }
}

// ======================
// COMMISSION
// ======================
function logDeal() {
  const value = parseFloat(document.getElementById('dealInput').value);
  if (!value || value <= 0) {
    alert('Please enter a valid contract value');
    return;
  }

  const commission = Math.round(value * (STATE.rate / 100));
  const deal = {
    id: 'deal_' + Date.now(),
    value: value,
    rate: STATE.rate,
    commission: commission,
    timestamp: new Date().toISOString()
  };

  STATE.deals.push(deal);
  saveData();
  updateCommission();

  document.getElementById('dealInput').value = '';
  alert(`Deal logged! Commission: $${commission.toLocaleString()}`);
}

function setGoal() {
  const goal = parseFloat(document.getElementById('goalInput').value);
  if (!goal || goal <= 0) {
    alert('Please enter a valid goal amount');
    return;
  }

  STATE.goal = goal;
  saveData();
  updateCommission();
  document.getElementById('goalInput').value = '';
  alert('Goal updated!');
}

function updateCommission() {
  const now = new Date();
  const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
  
  const monthDeals = STATE.deals.filter(d => new Date(d.timestamp) >= monthStart);
  const totalValue = monthDeals.reduce((sum, d) => sum + d.value, 0);
  const totalComm = monthDeals.reduce((sum, d) => sum + d.commission, 0);
  const proposals = STATE.leads.filter(l => new Date(l.savedAt) >= monthStart).length;

  document.getElementById('propCount').textContent = proposals;
  document.getElementById('dealCount').textContent = monthDeals.length;
  document.getElementById('contractVal').textContent = '$' + totalValue.toLocaleString();
  document.getElementById('totalComm').textContent = '$' + totalComm.toLocaleString();
  document.getElementById('commBadge').textContent = '$' + totalComm.toLocaleString();

  const goalPct = Math.min(100, (totalComm / STATE.goal) * 100);
  document.getElementById('goalFill').style.width = goalPct + '%';
  document.getElementById('goalText').textContent = `$${totalComm.toLocaleString()} / $${STATE.goal.toLocaleString()}`;
}

// ======================
// UI UPDATES
// ======================
function updateUI() {
  const statusEl = document.getElementById('statusText');
  const controlBtn = document.getElementById('controlBtn');
  const radarCenter = document.getElementById('radarCenter');
  const radarSweep = document.getElementById('radarSweep');
  const progressCircle = document.getElementById('progressCircle');

  // Status text
  const statusMap = {
    'IDLE': 'Ready to Hunt',
    'TRACKING': 'üõ∞Ô∏è Tracking...',
    'DWELLING': '‚è±Ô∏è Detecting Dwell...',
    'CAPTURED': 'üéØ Lead Captured!'
  };
  statusEl.textContent = statusMap[STATE.status] || 'Ready';

  // Control button
  if (STATE.tracking) {
    controlBtn.className = 'btn btn-stop';
    controlBtn.innerHTML = '‚èπÔ∏è Stop Route';
  } else {
    controlBtn.className = 'btn btn-primary';
    controlBtn.innerHTML = 'üß≠ Start Route';
  }

  // Radar center
  radarCenter.classList.remove('tracking', 'dwelling', 'captured');
  if (STATE.status === 'TRACKING') {
    radarCenter.classList.add('tracking');
    radarCenter.textContent = 'üì°';
  } else if (STATE.status === 'DWELLING') {
    radarCenter.classList.add('dwelling');
    radarCenter.textContent = '‚è±Ô∏è';
  } else if (STATE.status === 'CAPTURED') {
    radarCenter.classList.add('captured');
    radarCenter.textContent = 'üéØ';
  } else {
    radarCenter.textContent = 'üß≠';
  }

  // Radar sweep
  radarSweep.classList.remove('active', 'dwelling');
  if (STATE.tracking) {
    radarSweep.classList.add('active');
    if (STATE.status === 'DWELLING') {
      radarSweep.classList.add('dwelling');
    }
  }

  // Progress ring (dwell progress)
  const circumference = 283; // 2 * PI * 45
  if (STATE.status === 'DWELLING' && STATE.dwellDuration > 0) {
    const progress = Math.min(STATE.dwellDuration / CONFIG.DWELL_THRESHOLD, 1);
    const offset = circumference - (progress * circumference);
    progressCircle.style.strokeDashoffset = offset;
  } else {
    progressCircle.style.strokeDashoffset = circumference;
  }

  // Speed
  const speedEl = document.getElementById('speedValue');
  speedEl.textContent = STATE.speed !== null ? Math.round(STATE.speed) : '--';

  // Dwell time
  const dwellEl = document.getElementById('dwellTime');
  dwellEl.textContent = formatDuration(STATE.dwellDuration);
}

function updateLocationCard() {
  const card = document.getElementById('locCard');
  const locText = document.getElementById('locText');
  const accText = document.getElementById('accText');

  if (STATE.position) {
    card.style.display = 'block';
    locText.textContent = `${STATE.position.lat.toFixed(6)}, ${STATE.position.lon.toFixed(6)}`;
    accText.textContent = `Accuracy: ¬±${Math.round(STATE.position.accuracy)}m`;
  } else {
    card.style.display = 'none';
  }
}

function updateConnectionStatus(online) {
  const badge = document.getElementById('connBadge');
  if (online) {
    badge.className = 'conn-badge online';
    badge.textContent = 'üì∂ Online';
  } else {
    badge.className = 'conn-badge offline';
    badge.textContent = 'üìµ Offline';
  }
}

// ======================
// UTILITIES
// ======================
function formatDuration(ms) {
  if (!ms || ms < 0) return '0:00';
  const totalSeconds = Math.floor(ms / 1000);
  const minutes = Math.floor(totalSeconds / 60);
  const seconds = totalSeconds % 60;
  return `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

// Expose functions to global scope for onclick handlers
window.viewLead = viewLead;
window.deleteLead = deleteLead;
window.callLead = callLead;
window.navigateTo = navigateTo;
window.generateProposal = generateProposal;
window.removeCompetitor = removeCompetitor;
window.STATE = STATE;
</script>

</body>
</html>
